<script setup lang="ts">
    import { type Component, computed } from "vue";
    import File from "@/show/components/fields/text/nodes/Upload.vue";
    import Html from "@/show/components/fields/text/nodes/Html.vue";
    import { ShowFieldProps } from "@/show/types";
    import { ShowTextFieldData } from "@/types";
    import Embed from "@/show/components/fields/text/nodes/Embed.vue";

    const props = defineProps<ShowFieldProps<ShowTextFieldData> & {
        content: string,
    }>();

    const formattedContent = computed(() => {
        const dom = document.createElement('template');
        dom.innerHTML = props.content;
        dom.content.querySelectorAll('[data-html-content]').forEach(htmlNode => {
            const component = document.createElement('html-content');
            component.setAttribute('content', htmlNode.innerHTML.trim());
            dom.content.insertBefore(component, htmlNode);
            dom.content.removeChild(htmlNode);
        });
        return dom.innerHTML;
    })

    const component = computed<Component>(() => ({
        template: `<div>${formattedContent.value}</div>`,
        components: {
            'x-sharp-file': File,
            'x-sharp-image': File,
            'html-content': Html,
            ...Object.fromEntries(
                Object.entries(props.field.embeds ?? {})
                    .map(([embedKey, embed]) => [embed.tag, Embed])
            ),
        },
    }));
</script>

<template>
    <component :is="component" />
</template>

