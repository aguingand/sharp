# Upgrading from 8.x to 9.x

## Get new assets, clear cache

This is true for every update: be sure to grab the latest assets and to clear the view cache:

```bash
php artisan vendor:publish --provider="Code16\Sharp\SharpServiceProvider" --tag=assets
php artisan view:clear
```

## Deprecated methods have been removed

- Entity List: deprecated `buildListFields()` and `buildListLayout()` were removed, use `buildList()` instead
- Form: deprecated `delete()` method was removed (since it was moved to show / entity list in 8.x)

## New middlewares to declare

Due to migration to inertia, two middlewares must be added to the `sharp.middleware.web` config:

```php
// config/sharp.php

return [
    'middleware' => [
        //...
        'web' => [
            // ...
            \Code16\Sharp\Http\Middleware\HandleSharpErrors::class,
            \Code16\Sharp\Http\Middleware\HandleInertiaRequests::class,
        ],
    ],
]
```

## Page Alerts (aka global messages) need a substantial rewrite 

This part has been entirely rewritten, and will need substantial changes in your code.

In 8.x and below, you were asked to configure page alerts in the `buildConfig()` method; and if your page alert was displaying dynamic data, you had to use a custom transformer to inject the data in the page alert. All of this was removed, in favor of a much simpler back only system. Here’s an example of a page alert in a Show Page, but this is the same in Form, Dashboard, Entity List, Embed and Command cases:

```php
class MyShow extends SharpShow
{
    // [...]
    
    protected function buildPageAlert(PageAlert $pageAlert): void
    {
        $pageAlert
            ->setLevelInfo()
            ->setMessage(function (array $data) {
                return $data['is_planned']
                    ? sprintf(
                        'This post is planned for publication, on %s',
                        $data['published_at'],
                    )
                    : null;
            });
    }
}
```

As you can see, this new `buildPageAlert()` method takes a `PageAlert` object as parameter to work with. You'll have access to the `$data` array returned by your `find()` or `getListData()` method, to inject dynamic data in your page alert if needed. Vue templates are no longer handed, as the page alert is now rendered on the back only.

## New validation system (and deprecation of the old one)

The validation system was odd, for legacy reasons. 
In 9.x, it has been rewritten to be in phase with Laravel and to be more consistent:

- validation rules can now be defined in a `rules()` method of the form / command class,
- or with a `->validate($data, $rules)` call before update / store.
- The `$formValidatorClass` property usage, in a `SharpForm`, is now deprecated (you are strongly encouraged to migrate to the `rules()` method instead).

This version brings two huge benefits (besides the fact that it's clearer):

- the "delayed creation" thing is gone: the `{id}` parameter in a `SharpFormUploadField` storageBasePath isn't anymore an issue in creation case as Sharp will no longer call the `update()` method twice.
- Validation is now called AFTER data formatters, even in `SharpForm` (it was already the case with `Command`).

Breaking changes: the 8.x and below validation is still allowed, but deprecated. If you decide to migrate (and you should), pay attention to:

- remove special workarounds you may have done to handle the "delayed creation" thing,
- remove the `.text` suffix you may have added for `SharpFormEditorField` validation rules.

## Form and Show layout methods were renamed (old ones are deprecated)

The `->withSingleField()` method was deprecated, in favor of:
- `->withField(string $fieldKey)` for simple fields
- `->withListField(string $fieldKey, Closure $subLayoutCallback)` for List fields, which requires a sub-layout handled by a callback.

The method `->withFields(string ...$fieldKeys)`, used for multiple fields layout, remains unchanged.

## Related models handing in custom transformers was fixed (and potentially breaking)

This bug fix potentially brings a breaking change: if you were using a custom transformer to handle related models, you may have to update it.

Here’s code which will work in Sharp 8.x and below:

```php
$this
    ->setCustomTransformer('customer:name', fn ($value, $instance, $attribute) { 
        return $instance->customer->name; // $instance is the Order
    })
    ->transform(Order::find(1))
```

Is has to be rewritten like this in Sharp 9.x:

```php
$this
    ->setCustomTransformer('customer:name', fn ($value, $instance, $attribute) { 
        return $instance->name; // $instance is the Customer, as it should be.
    })
    ->transform(Order::find(1))
```

The main difference is that the `$instance` parameter refers to the related model, not the main model anymore. To summarize:

In 8.x:
```php
$value: 'Joe Doe'
$instance: // the Order instance
$attribute: 'customer:name'
```

In 9.x:
```php
$value: 'Joe Doe'
$instance: // the **Customer** instance
$attribute: 'name'
```

## `SharpFormUploadField`’s image related methods were renamed

This isn't a breaking change, since the old methods are still available, but deprecated. You should migrate to the new methods:

- `setFileFilterImage()` -> `setImageOnly()`
- `setCropRatio()` = `setImageCropRatio()`
- `shouldOptimizeImage()` = `setImageOptimize()`
- `setTransformable()` = `setImageTransformable()`
- `setCompactThumbnail()` = `setImageCompactThumbnail()`

and in addition:
 
- `setFilterFilter()` -> `setAllowedExtensions()`

See [full documentation here](../form-fields/upload.md).


## The API for embedded uploads in Editor field was rewritten

The `SharpFormEditorField` no longer has all the upload-related methods directly in the class. Instead, you must use a new `SharpFormEditorEmbedUpload` builder class, passed as a parameter to the `allowUploads()` method.

In 8.x:
```php
// in a SharpForm
public function buildFormFields(): void
{
    $this->addField(
        SharpFormEditorField::make('content')
            ->setMaxLength(1000)
            ->setToolbar([
                SharpFormEditorField::B,
                SharpFormEditorField::A,
                SharpFormEditorField::UPLOAD,
            ])
            ->setStorageDisk('local')
            ->setStorageBasePath('data/posts/{id}/embed'),
        )
    );
}
```

In 9.x:
```php
// in a SharpForm
public function buildFormFields(): void
{
    $this->addField(
        SharpFormEditorField::make('content')
            ->setMaxLength(1000)
            ->setToolbar([
                SharpFormEditorField::B,
                SharpFormEditorField::A,
                SharpFormEditorField::UPLOAD,
            ])
            ->allowUploads(
                SharpFormEditorEmbedUpload::make()
                    ->setStorageDisk('local')
                    ->setStorageBasePath('data/posts/{id}/embed')
            );
    );
}
```

See [full documentation here](../form-fields/editor.md).

## New markup for Embedded uploads (in Editor field)

I you're using editor uploads, you will need migrate `<x-sharp-image>` and `<x-sharp-file>` elements in the content. We provide a helper trait to be used as follows :

```php
use Code16\Sharp\Form\Eloquent\Migrations\MigrateContentsForSharp9;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

new class extends Migration
{
    use MigrateContentsForSharp9;

    public function up(): void
    {
        $this->updateContentOf(DB::table('posts'), ['content']);
    }
}
```

## Thumbnails custom filters must be refactored to Modifiers

First, if you defined custom filters classes for youy thumbnails, you must refactor it to The new ThumbnailModifier API, which is very close:

In 8.x
```php
class MyFilter extends ThumbnailFilter
{
    public function applyFilter(Image $image): Image
    {
        // ...
    }
}
```

In 9.x
```php
class MyModifier extends ThumbnailModifier
{
    public function apply(ImageInterface $image): ImageInterface
    {
        // ...
    }
}
```

And second, in 9.x you can’t pass modifier's parameters as an array anymore:

In 8.x
```php
$book->cover->thumbnail(100, 100, ['fit'=>['w'=>100, 'h'=>100]]);
```

In 9.x
```php
$book->cover->thumbnail(100, 100, [new FitModifier(100, 100)]);

// or with the new fluent API
$book->cover->thumbnail()
    ->addModifier(new FitModifier(100, 100))
    ->make();
```

## Some config keys where moved / renamed + explicit config is required for custom menu / login images

Config keys were moved / renamed for consistency; old keys are still supported, but deprecated. You should update your `config/sharp.php` file to use the new keys.

In 8.x:
```php
// config/sharp.php

return [
    // [...]
    'display_breadcrumb' => false,
    
    'auth'=> [
        // [...]
        'suggest_remember_me' => false,
    ],
    
    // [...]
    'login_page_message_blade_path' => 'sharp/_login-page-message',
    
    'theme' => [
        // [...]
        'logo_urls' => [
            'menu' => '/public/sharp-assets/menu-icon.png',
            'login' => '/public/sharp-assets/login-icon.png',
        ],
    ],
];
```

In 9.x:
```php
// config/sharp.php

return [
    // [...]
    'display_breadcrumb' => true, // Default is now true
    
    'auth' => [
        // [...]
        'login_form' => [
            'suggest_remember_me' => false,
            'display_app_name' => true, // New option
            'logo_url' => '/sharp-assets/login-logo.png',
            'message_blade_path' => 'sharp/_login-page-message',
        ],
    ],
    
    'theme' => [
        // [...]
        'logo_url' => '/public/sharp-assets/menu-icon.png',
    ],
];
```

Secondly, in 8.x the special paths `/public/sharp-assets/menu-icon.png` and `/public/sharp-assets/login-icon.png` were automatically resolved: this is no longer the case in 9.x, you must explicitly declare them in the config file.

## `SharpAuthenticationCheckHandler` is now deprecated in favor of `viewSharp` Gate

The use of a `SharpAuthenticationCheckHandler` is now deprecated, and will be entirely removed in a future version. You should migrate your handler to a Gate:

In 8.x:
```php
class MySharpAuthenticationCheckHandler implements SharpAuthenticationCheckHandler
{
    public function check(Authenticatable $user): bool;
    {
        return $user->is_sharp_admin;
    }
}
```

In 9.x:
```php
class AppServiceProvider extends ServiceProvider
{
    // [...]

    public function boot(): void
    {
        Gate::define('viewSharp', fn ($user) => $user->is_sharp_admin);
    }
}
```

Next, the `sharp.auth.check_handler` config key can be safely removed from your `config/sharp.php` file, along with the `SharpAuthenticationCheckHandler` implementation class.

## New performance optimization for Commands and Policies in Entity List (n+1)

This is not a breaking change, in fact you can ignore this step entirely, but since it's new and it can lead to huge performance boost, this is worth mentioning: you can now quite easily implement a [caching mechanism of instances for your Commands and Policies in Entity List](../avoid-n1-queries-in-entity-lists.md).
